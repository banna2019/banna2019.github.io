(window.webpackJsonp=window.webpackJsonp||[]).push([[92],{427:function(s,a,t){"use strict";t.r(a);var n=t(4),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h4",{attrs:{id:"一、实践介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、实践介绍"}},[s._v("#")]),s._v(" 一、实践介绍")]),s._v(" "),a("h5",{attrs:{id:"云产品资源"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#云产品资源"}},[s._v("#")]),s._v(" 云产品资源")]),s._v(" "),a("ul",[a("li",[s._v("网络(VirtualNet)\n"),a("ul",[a("li",[s._v("ZONE")]),s._v(" "),a("li",[s._v("Subnet")])])]),s._v(" "),a("li",[s._v("负载均衡 Load Balancer")]),s._v(" "),a("li",[s._v("云服务器 VM")]),s._v(" "),a("li",[s._v("对象存储")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220922164959289.png",alt:"image-20220922164959289"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220922165049744.png",alt:"image-20220922165049744"}})]),s._v(" "),a("h4",{attrs:{id:"二、初始化配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、初始化配置"}},[s._v("#")]),s._v(" 二、初始化配置")]),s._v(" "),a("h5",{attrs:{id:"地域和可用区"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#地域和可用区"}},[s._v("#")]),s._v(" 地域和可用区")]),s._v(" "),a("blockquote",[a("p",[s._v("https://docs.microsoft.com/en-us/azure/availability-zones/az-overview")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220922185515984.png",alt:"image-20220922185515984"}})]),s._v(" "),a("h5",{attrs:{id:"安装azure-cli"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装azure-cli"}},[s._v("#")]),s._v(" 安装Azure-CLI")]),s._v(" "),a("blockquote",[a("p",[s._v("https://learn.microsoft.com/zh-cn/cli/azure/install-azure-cli")]),s._v(" "),a("p",[s._v("https://docs.azure.cn/zh-cn/cli/install-azure-cli-yum?view=azure-cli-latest")]),s._v(" "),a("p",[s._v("az账户登录: https://learn.microsoft.com/zh-cn/cli/azure/authenticate-azure-cli")])]),s._v(" "),a("h6",{attrs:{id:"centos安装-azure-cli"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#centos安装-azure-cli"}},[s._v("#")]),s._v(' CentOS安装"Azure-cli"')]),s._v(" "),a("blockquote",[a("p",[s._v("CentOS系统登录"),a("code",[s._v("Azure")]),s._v("账户需要使用"),a("code",[s._v("az login --use-device-code")]),s._v("方式登录,正常方式不适用")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# CentOS7 配置`azure-cli`yum源")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rpm")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--import")]),s._v(" https://packages.microsoft.com/keys/microsoft.asc\n\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-e")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"[azure-cli]\nname=Azure CLI\nbaseurl=https://packages.microsoft.com/yumrepos/azure-cli\nenabled=1\ngpgcheck=1\ngpgkey=https://packages.microsoft.com/keys/microsoft.asc"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tee")]),s._v(" /etc/yum.repos.d/azure-cli.repo\n\n$ yum makecahe\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用dnf install命令安装`azure-cli`")]),s._v("\n$ yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" dnf "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v("\n$ dnf "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" azure-cli "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 登陆和退出Azure账户")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 将登录`https://microsoft.com/devicelogin`地址拷贝到浏览器上进行操作,然后将验证的`HJ7FST4R7`KEY拷贝到时候使用")]),s._v("\n$ az login --use-device-code\nTo sign in, use a web browser to "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),s._v(" the page https://microsoft.com/devicelogin and enter the code HE4HDF9P8 to authenticate.\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 登录后的返回结果")]),s._v("\naz login --use-device-code\nTo sign in, use a web browser to "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),s._v(" the page https://microsoft.com/devicelogin and enter the code HJ7FST4R7 to authenticate.\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cloudName"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"AzureCloud"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"homeTenantId"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"39e875d4-60ed-4dea-b35b-5efbccf67d48"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"id"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"d3a12c16-4024-403e-826f-fdd73da900e8"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"isDefault"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" true,\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"managedByTenants"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"免费试用"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"state"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Enabled"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tenantId"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"39e875d4-60ed-4dea-b35b-5efbccf67d48"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"xxxxxxx1@gmail.com"')]),s._v(",\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"type"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220922210938915.png",alt:"image-20220922210938915"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220922194249649.png",alt:"image-20220922194249649"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220922210955842.png",alt:"image-20220922210955842"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220922210030942.png",alt:"image-20220922210030942"}})]),s._v(" "),a("h6",{attrs:{id:"其他环境安装azure-cli"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#其他环境安装azure-cli"}},[s._v("#")]),s._v(" 其他环境安装Azure CLI")]),s._v(" "),a("ul",[a("li",[s._v("参考"),a("code",[s._v("Azure CLI安装.md")]),s._v("文档")])]),s._v(" "),a("h5",{attrs:{id:"配置terraform本地缓存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置terraform本地缓存"}},[s._v("#")]),s._v(" 配置Terraform本地缓存")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 项目目录结构")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" terraform-azure-operator\n$ tree "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n├── "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),s._v("\n│   └── dev\n│       ├── network\n│       └── "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v("\n├── global\n│   └── backend\n└── modules\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" directories\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在根目录创建`.terraformrc`文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('## 本地缓存目录: "$HOME/.terraform.d/terraform-plugin-cache" 或 "/root/.terraform.d/terraform-plugin-cache"')]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" .terraformrc\nplugin_cache_dir  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v('/.terraform.d/terraform-plugin-cache"')]),s._v("\ndisable_checkpoint "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n\nprovider_installation "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  filesystem_mirror "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    path    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/root/.terraform.d/terraform-plugin-cache"')]),s._v("\n    include "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"registry.terraform.io/*/*"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br")])]),a("h5",{attrs:{id:"backend初始化配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#backend初始化配置"}},[s._v("#")]),s._v(" Backend初始化配置")]),s._v(" "),a("blockquote",[a("p",[s._v("https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入目录")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" terraform-azure-operator/global/backend\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" versions.tf  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 编辑`versions.tf `文件")]),s._v("\nterraform "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  required_providers "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    azurerm "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hashicorp/azurerm"')]),s._v("\n      version "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"=3.23.0"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 初始化项目并下载terraform provider plugin组件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 这里报错需要先去除`.terraformrc`文件中的如下部分,等`terraform init`完成之后再添加回去即可")]),s._v("\nprovider_installation "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  filesystem_mirror "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    path    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/root/.terraform.d/terraform-plugin-cache"')]),s._v("\n    include "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"registry.terraform.io/*/*"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 报错信息")]),s._v("\n$ terraform init\n\nInitializing the backend"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\nInitializing provider plugins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n- Finding hashicorp/azurerm versions matching "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3.23.0"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n╷\n│ Error: Failed to query available provider packages\n│\n│ Could not retrieve the list of available versions "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" provider hashicorp/azurerm: provider registry.terraform.io/hashicorp/azurerm was not found\n│ "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" any of the search locations\n│\n│   - /mnt/e/Github-Project/Terraform-Home/.terraform.d/terraform-plugin-cache\n╵\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 初始化正常")]),s._v("\n$ terraform init\n\nInitializing the backend"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\nInitializing provider plugins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n- Reusing previous version of hashicorp/azurerm from the dependency lock "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v("\n- Using previously-installed hashicorp/azurerm v3.23.0\n\nTerraform has been successfully initialized"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\n\nYou may now begin working with Terraform. Try running "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terraform plan"')]),s._v(" to see\nany changes that are required "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" your infrastructure. All Terraform commands\nshould now work.\n\nIf you ever "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" or change modules or backend configuration "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" Terraform,\nrerun this "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("command")]),s._v(" to reinitialize your working directory. If you forget, other\ncommands will detect it and remind you to "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" so "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" necessary.\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br")])]),a("h6",{attrs:{id:"azure-storage-account"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#azure-storage-account"}},[s._v("#")]),s._v(" Azure Storage Account")]),s._v(" "),a("p",[s._v("存储帐户包含所有 Azure 存储数据对象：blobs, file shares, queues, tables, and disks. 存储帐户为你的 Azure 存储数据提供了一个唯一的命名空间；存储帐户名称在 Azure 中必须是唯一的")]),s._v(" "),a("blockquote",[a("p",[s._v("https://learn.microsoft.com/en-us/azure/storage/common/storage-account-overview?toc=%2Fazure%2Fstorage%2Fblobs%2Ftoc.json")]),s._v(" "),a("p",[s._v("https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/storage_account")]),s._v(" "),a("p",[s._v("https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/storage_container")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入项目目录")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" terraform-azure-operator/global/backend\n$ ree ./\n./\n├── main.tf\n└── versions.tf\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" directories, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" files\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 登录Azure")]),s._v("\n$ az login --use-device-code\nTo sign in, use a web browser to "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),s._v(" the page https://microsoft.com/devicelogin and enter the code HJ7FST4R7 to authenticate.\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cloudName"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"AzureCloud"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"homeTenantId"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"39e875d4-60ed-4dea-b35b-5efbccf67d48"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"id"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"d3a12c16-4024-403e-826f-fdd73da900e8"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"isDefault"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" true,\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"managedByTenants"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"免费试用"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"state"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Enabled"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tenantId"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"39e875d4-60ed-4dea-b35b-5efbccf67d48"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"xxxxxx@gmail.com"')]),s._v(",\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"type"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 声明环境变量")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TF_CLI_CONFIG_FILE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/home/terraform/youdianzhishi-terraform/terraform-azure-operator/.terraformrc\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行terraform命令")]),s._v("\n$ terraform init \n$ terraform "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("fmt")]),s._v(" 或 terraform init "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-recursive")]),s._v("\n$ terraform validate\n$ terraform plan\n$ terraform apply 或 terraform apply -auto-approve\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br")])]),a("p",[a("strong",[s._v("备注")])]),s._v(" "),a("ul",[a("li",[s._v("控制台查看"),a("code",[s._v("Azure Storage Account")]),s._v("的创建结果")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220922213542277.png",alt:"image-20220922213542277"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220922213616057.png",alt:"image-20220922213616057"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220922214205776.png",alt:"image-20220922214205776"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220922214744253.png",alt:"image-20220922214744253"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220922214824628.png",alt:"image-20220922214824628"}})]),s._v(" "),a("h6",{attrs:{id:"backend同步状态到远程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#backend同步状态到远程"}},[s._v("#")]),s._v(" Backend同步状态到远程")]),s._v(" "),a("blockquote",[a("p",[s._v("https://www.terraform.io/language/settings/backends/azurerm")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入项目目录")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" terraform-azure-operator/global/backend\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" backend.tf\nterraform "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  backend "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"azurerm"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    resource_group_name  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terraform-demo"')]),s._v("\n    storage_account_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tfstateadmin111"')]),s._v("\n    container_name       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tfstate"')]),s._v("\n    key                  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"global/backend/terraform-backend.tfstate"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 登录Azure")]),s._v("\n$ az login --use-device-code\nTo sign in, use a web browser to "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),s._v(" the page https://microsoft.com/devicelogin and enter the code HJ7FST4R7 to authenticate.\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cloudName"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"AzureCloud"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"homeTenantId"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"39e875d4-60ed-4dea-b35b-5efbccf67d48"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"id"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"d3a12c16-4024-403e-826f-fdd73da900e8"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"isDefault"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" true,\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"managedByTenants"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"免费试用"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"state"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Enabled"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tenantId"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"39e875d4-60ed-4dea-b35b-5efbccf67d48"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"xxxxxx@gmail.com"')]),s._v(",\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"type"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 声明环境变量")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TF_CLI_CONFIG_FILE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/home/terraform/youdianzhishi-terraform/terraform-azure-operator/.terraformrc\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行terraform命令")]),s._v("\n$ terraform init \n$ terraform "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("fmt")]),s._v(" 或 terraform init "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-recursive")]),s._v("\n$ terraform validate\n$ terraform plan\n$ terraform apply 或 terraform apply -auto-approve\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# terraform init初始化并同步状态到远程")]),s._v("\n$ terraform  init\n\nInitializing the backend"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nAcquiring state lock. This may take a few moments"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nDo you want to copy existing state to the new backend?\n  Pre-existing state was found "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" migrating the previous "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"local"')]),s._v(" backend to the\n  newly configured "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"azurerm"')]),s._v(" backend. No existing state was found "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" the newly\n  configured "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"azurerm"')]),s._v(" backend. Do you want to copy this state to the new "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"azurerm"')]),s._v("\n  backend? Enter "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"yes"')]),s._v(" to copy and "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"no"')]),s._v(" to start with an empty state.\n\n  Enter a value: "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n\nReleasing state lock. This may take a few moments"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\nSuccessfully configured the backend "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"azurerm"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" Terraform will automatically\nuse this backend unless the backend configuration changes.\n\nInitializing provider plugins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n- Reusing previous version of hashicorp/azurerm from the dependency lock "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v("\n- Using previously-installed hashicorp/azurerm v3.23.0\n\nTerraform has been successfully initialized"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\n\nYou may now begin working with Terraform. Try running "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terraform plan"')]),s._v(" to see\nany changes that are required "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" your infrastructure. All Terraform commands\nshould now work.\n\nIf you ever "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" or change modules or backend configuration "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" Terraform,\nrerun this "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("command")]),s._v(" to reinitialize your working directory. If you forget, other\ncommands will detect it and remind you to "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" so "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" necessary.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br")])]),a("p",[a("strong",[s._v("备注")])]),s._v(" "),a("ul",[a("li",[s._v("控制台查看state的同步结果")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220922215753987.png",alt:"image-20220922215753987"}})]),s._v(" "),a("h4",{attrs:{id:"二、开通虚拟网络和子网资源"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、开通虚拟网络和子网资源"}},[s._v("#")]),s._v(" 二、开通虚拟网络和子网资源")]),s._v(" "),a("h5",{attrs:{id:"创建资源"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建资源"}},[s._v("#")]),s._v(" 创建资源")]),s._v(" "),a("ul",[a("li",[s._v("VirtualNetwork 虚拟网络")]),s._v(" "),a("li",[s._v("Subnet 子网")])]),s._v(" "),a("blockquote",[a("p",[s._v("https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/virtual_network")]),s._v(" "),a("p",[s._v("https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/subnet")]),s._v(" "),a("p",[s._v('这里依赖的是modules下面的模块创建的资源: "terraform-azure-operator/modules/virtul-net"')])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入项目目录")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" terraform-azure-operator/env/dev/network\n$  tree  ./\n./\n├── backend.tf\n├── outputs.tf\n├── variables.tf\n├── versions.tf\n└── virtual-net.tf\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" directories, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" files\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 登录Azure")]),s._v("\n$ az login --use-device-code\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 声明环境变量")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TF_CLI_CONFIG_FILE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/home/terraform/youdianzhishi-terraform/terraform-azure-operator/.terraformrc\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行terraform命令")]),s._v("\n$ terraform init \n$ terraform "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("fmt")]),s._v(" 或 terraform init "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-recursive")]),s._v("\n$ terraform validate\n$ terraform plan\n$ terraform apply 或 terraform apply -auto-approve\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("p",[a("strong",[s._v("备注")]),s._v(":")]),s._v(" "),a("ul",[a("li",[s._v("项目这里创建的虚拟网络和子网是调用modules下的virtual-net模块进行创建的")]),s._v(" "),a("li",[s._v("控制台验证虚拟网络和子网的创建结果")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220922224127628.png",alt:"image-20220922224127628"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220922224608802.png",alt:"image-20220922224608802"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220922224644594.png",alt:"image-20220922224644594"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220923001259053.png",alt:"image-20220923001259053"}})]),s._v(" "),a("h4",{attrs:{id:"三、开通安全组资源"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、开通安全组资源"}},[s._v("#")]),s._v(" 三、开通安全组资源")]),s._v(" "),a("ul",[a("li",[s._v("security_group 安全组和规则")])]),s._v(" "),a("blockquote",[a("p",[s._v("https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network_security_group")]),s._v(" "),a("p",[s._v("https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/subnet_network_security_group_association")]),s._v(" "),a("p",[s._v('这里依赖的是modules下面的模块创建的资源: "terraform-azure-operator/modules/security-group"')])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入项目目录")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" terraform-azure-operator/env/dev/network\n$  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" network-security_group.tf\nlocals "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  security_group_name          "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dev-network-secgroup"')]),s._v("\n  secgroup_location_name       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"East US"')]),s._v("\n  secgroup_resource_group_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terraform-demo"')]),s._v("\n  secgroup_env_name            "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dev-network-security-group"')]),s._v("\n  subnet_ids                   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" module.network.network_subnet_ids\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nmodule "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"security-groups"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("                       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"../../../modules/security-group"')]),s._v("\n  security_group_name          "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" local.security_group_name\n  secgroup_location_name       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" local.secgroup_location_name\n  secgroup_resource_group_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" local.secgroup_resource_group_name\n  secgroup_env_name            "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" local.secgroup_env_name\n  subnet_ids                   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" local.subnet_ids\n\n  ports "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      port     "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"80"')]),s._v("\n      priority "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      port     "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"22"')]),s._v("\n      priority "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("101")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      port     "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"443"')]),s._v("\n      priority "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("102")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 登录Azure")]),s._v("\n$ az login --use-device-code\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 声明环境变量")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TF_CLI_CONFIG_FILE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/home/terraform/youdianzhishi-terraform/terraform-azure-operator/.terraformrc\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行terraform命令")]),s._v("\n$ terraform init \n$ terraform "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("fmt")]),s._v(" 或 terraform init "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-recursive")]),s._v("\n$ terraform validate\n$ terraform plan\n$ terraform apply 或 terraform apply -auto-approve\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br")])]),a("p",[a("strong",[s._v("备注")]),s._v(":")]),s._v(" "),a("ul",[a("li",[s._v("项目这里创建的子网安全组是调用modules下的security-group模块进行创建的")]),s._v(" "),a("li",[s._v("控制台验证子网安全组的创建结果")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220923105950836.png",alt:"image-20220923105950836"}})]),s._v(" "),a("h4",{attrs:{id:"四、开通网络接口和公网ip"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四、开通网络接口和公网ip"}},[s._v("#")]),s._v(" 四、开通网络接口和公网IP")]),s._v(" "),a("h5",{attrs:{id:"公共参数剥离"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#公共参数剥离"}},[s._v("#")]),s._v(" 公共参数剥离")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入项目目录")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" terraform-azure-operator/env/dev/network\n$  tree  ./\n./\n├── backend.tf\n├── main.tf\n├── network-security_group.tf\n├── outputs.tf\n├── variables.tf\n├── versions.tf\n└── virtual-net.tf\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" directories, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" files\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看独立出来的公共参数")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" main.tf \nlocals "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  location_name       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"East US"')]),s._v("\n  resource_group_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terraform-demo"')]),s._v("\n  subnet_ids "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" module.network.network_subnet_ids\n  env_name   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dev"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 登录Azure")]),s._v("\n$ az login --use-device-code\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 声明环境变量")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TF_CLI_CONFIG_FILE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/home/terraform/youdianzhishi-terraform/terraform-azure-operator/.terraformrc\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行terraform命令")]),s._v("\n$ terraform init \n$ terraform "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("fmt")]),s._v(" 或 terraform init "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-recursive")]),s._v("\n$ terraform validate\n$ terraform plan\n$ terraform apply 或 terraform apply -auto-approve\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br")])]),a("h5",{attrs:{id:"创建公网ip"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建公网ip"}},[s._v("#")]),s._v(" 创建公网IP")]),s._v(" "),a("blockquote",[a("p",[s._v("https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/public_ip")]),s._v(" "),a("p",[s._v('这里依赖的是modules下面的模块创建的资源: "terraform-azure-operator/modules/public-ip"')])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入项目目录")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" terraform-azure-operator/env/dev/network\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 依赖公共参数")]),s._v("\n$  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" main.tf\nlocals "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  location_name       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"East US"')]),s._v("\n  resource_group_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terraform-demo"')]),s._v("\n  env_name   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dev"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 穿件公网IP")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" public_ip.tf\nmodule "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"public-ip"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("              "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"../../../modules/public-ip"')]),s._v("\n  location_name       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" local.location_name\n  resource_group_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" local.resource_group_name\n  env_name            "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" local.env_name\n  public_name_groups  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"serve01"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"server02"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 登录Azure")]),s._v("\n$ az login --use-device-code\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 声明环境变量")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TF_CLI_CONFIG_FILE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/home/terraform/youdianzhishi-terraform/terraform-azure-operator/.terraformrc\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行terraform命令")]),s._v("\n$ terraform init \n$ terraform "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("fmt")]),s._v(" 或 terraform init "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-recursive")]),s._v("\n$ terraform validate\n$ terraform plan\n$ terraform apply 或 terraform apply -auto-approve\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br")])]),a("p",[a("strong",[s._v("备注")]),s._v(":")]),s._v(" "),a("ul",[a("li",[s._v("项目这里创建的公网IP是调用modules下的public-ip模块进行创建的")]),s._v(" "),a("li",[s._v("控制台验证公网IP的创建结果")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220923151926609.png",alt:"image-20220923151926609"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220923151957291.png",alt:"image-20220923151957291"}})]),s._v(" "),a("h5",{attrs:{id:"vm-nic-网络接口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#vm-nic-网络接口"}},[s._v("#")]),s._v(" VM-NIC 网络接口")]),s._v(" "),a("ul",[a("li",[s._v("创建VM-NIC网络接口并关联上 上面的公网IP地址")])]),s._v(" "),a("blockquote",[a("p",[s._v("https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network_interface")]),s._v(" "),a("p",[s._v('这里依赖的是modules下面的模块创建的资源: "terraform-azure-operator/modules/nics"')])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入项目目录")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" terraform-azure-operator/env/dev/network\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 依赖的公共参数")]),s._v("\n$  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" main.tf\nlocals "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  location_name       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"East US"')]),s._v("\n  resource_group_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terraform-demo"')]),s._v("\n  subnet_ids "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" module.network.network_subnet_ids\n  public_ids "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" module.public-ip.public_id_list\n  env_name   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dev"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建vm-nic并关联公网地址")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" vms.tf\nmodule "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"vms"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("              "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"../../../modules/vms"')]),s._v("\n  location_name       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" local.location_name\n  resource_group_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" local.resource_group_name\n  vms "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"serve01"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"server02"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  vms_configs "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    serve01 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      subnet_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${local.subnet_ids"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("0"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("}")]),s._v('"')]),s._v("\n      public_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${local.public_ids"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("0"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("}")]),s._v('"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n    server02 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      subnet_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${local.subnet_ids"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("}")]),s._v('"')]),s._v("\n      public_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${local.public_ids"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("}")]),s._v('"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 登录Azure")]),s._v("\n$ az login --use-device-code\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 声明环境变量")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TF_CLI_CONFIG_FILE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/home/terraform/youdianzhishi-terraform/terraform-azure-operator/.terraformrc\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行terraform命令")]),s._v("\n$ terraform init \n$ terraform "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("fmt")]),s._v(" 或 terraform init "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-recursive")]),s._v("\n$ terraform validate\n$ terraform plan\n$ terraform apply 或 terraform apply -auto-approve\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br")])]),a("p",[a("strong",[s._v("备注")]),s._v(":")]),s._v(" "),a("ul",[a("li",[s._v("项目这里创建的网络接口是调用modules下的nics模块进行创建的")]),s._v(" "),a("li",[s._v("控制台验证网络接口的创建结果")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220923145116039.png",alt:"image-20220923145116039"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220923151211280.png",alt:"image-20220923151211280"}})]),s._v(" "),a("h4",{attrs:{id:"五、开通linux虚拟机资源"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#五、开通linux虚拟机资源"}},[s._v("#")]),s._v(" 五、开通Linux虚拟机资源")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("过滤获取可用的image")]),s._v(" "),a("blockquote",[a("p",[s._v("https://learn.microsoft.com/en-us/azure/virtual-machines/linux/cli-ps-findimage")])])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看所有的 image")]),s._v("\n$ az vm image list "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--output")]),s._v(" table\nYou are viewing an offline list of images, use "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--all")]),s._v(" to retrieve an up-to-date list\nArchitecture    Offer                         Publisher               Sku                                 Urn                                                                             UrnAlias                 Version\n--------------  ----------------------------  ----------------------  ----------------------------------  ------------------------------------------------------------------------------  -----------------------  ---------\nx64             CentOS                        OpenLogic               "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7.5")]),s._v("                                 OpenLogic:CentOS:7.5:latest                                                     CentOS                   latest\nx64             debian-10                     Debian                  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("                                  Debian:debian-10:10:latest                                                      Debian                   latest\nx64             flatcar-container-linux-free  kinvolk                 stable                              kinvolk:flatcar-container-linux-free:stable:latest                              Flatcar                  latest\nx64             opensuse-leap-15-3            SUSE                    gen2                                SUSE:opensuse-leap-15-3:gen2:latest                                             openSUSE-Leap            latest\nx64             RHEL                          RedHat                  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("-LVM                               RedHat:RHEL:7-LVM:latest                                                        RHEL                     latest\nx64             sles-15-sp3                   SUSE                    gen2                                SUSE:sles-15-sp3:gen2:latest                                                    SLES                     latest\nx64             UbuntuServer                  Canonical               "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18.04")]),s._v("-LTS                           Canonical:UbuntuServer:18.04-LTS:latest                                         UbuntuLTS                latest\nx64             WindowsServer                 MicrosoftWindowsServer  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-Datacenter                     MicrosoftWindowsServer:WindowsServer:2022-Datacenter:latest                     Win2022Datacenter        latest\nx64             WindowsServer                 MicrosoftWindowsServer  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-datacenter-azure-edition-core  MicrosoftWindowsServer:WindowsServer:2022-datacenter-azure-edition-core:latest  Win2022AzureEditionCore  latest\nx64             WindowsServer                 MicrosoftWindowsServer  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("-Datacenter                     MicrosoftWindowsServer:WindowsServer:2019-Datacenter:latest                     Win2019Datacenter        latest\nx64             WindowsServer                 MicrosoftWindowsServer  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2016")]),s._v("-Datacenter                     MicrosoftWindowsServer:WindowsServer:2016-Datacenter:latest                     Win2016Datacenter        latest\nx64             WindowsServer                 MicrosoftWindowsServer  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2012")]),s._v("-R2-Datacenter                  MicrosoftWindowsServer:WindowsServer:2012-R2-Datacenter:latest                  Win2012R2Datacenter      latest\nx64             WindowsServer                 MicrosoftWindowsServer  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2012")]),s._v("-Datacenter                     MicrosoftWindowsServer:WindowsServer:2012-Datacenter:latest                     Win2012Datacenter        latest\nx64             WindowsServer                 MicrosoftWindowsServer  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2008")]),s._v("-R2-SP1                         MicrosoftWindowsServer:WindowsServer:2008-R2-SP1:latest                         Win2008R2SP1             latest\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 根据指定条件过滤image")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 区域为`westus` ,`publisher`为Canonical(典型),`offer`提供为`UbuntuServer`,`sku`为`18.04-LTS`")]),s._v("\naz vm image list "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--location")]),s._v(" westus "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--publisher")]),s._v(" Canonical "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--offer")]),s._v(" UbuntuServer "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--sku")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18.04")]),s._v("-LTS "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--all")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--output")]),s._v(" table\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## publisher为`Canonical`典型的")]),s._v("\n$ az vm image list "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--offer")]),s._v(" Ubuntu "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--all")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--publisher")]),s._v(" Canonical "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--output")]),s._v(" table\n$ az vm image list "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--offer")]),s._v(" Ubuntu "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--all")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--output")]),s._v(" table\n$ az vm image list "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--offer")]),s._v(" Centos "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--all")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--output")]),s._v(" table\n$ az vm image list "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--offer")]),s._v(" Ubuntu "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--all")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--output")]),s._v(" table"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("more")]),s._v("\nArchitecture    Offer                                               Publisher                           Sku                              \n                   Urn                                                                                                                   \n            Version\n--------------  --------------------------------------------------  ----------------------------------  ---------------------------------\n-----------------  ----------------------------------------------------------------------------------------------------------------------\n----------  ----------------\nx64             nsimd-ubuntu-20-04                                  ageniumscale1591804889317           plan-for-nsimd-ubuntu-20-04      \n                   ageniumscale1591804889317:nsimd-ubuntu-20-04:plan-for-nsimd-ubuntu-20-04:1.0.0                                        \n            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.0")]),s._v(".0\nx64             aquaveo-tethys-platform-33-ubuntu-2004              aquaveollc1633710529908             tethys33                         \n                   aquaveollc1633710529908:aquaveo-tethys-platform-33-ubuntu-2004:tethys33:3.3.0                                         \n            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.3")]),s._v(".0\nx64             abantecart-on-ubuntu-1804                           apps-4-rent                         abantecart-on-ubuntu-1804        \n                   apps-4-rent:abantecart-on-ubuntu-1804:abantecart-on-ubuntu-1804:1.0.1                                                 \n            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.0")]),s._v(".1\nx64             minecraft-bedrock-ubuntu-18-04-minimal              articentgroupllc1635512619530       minecraft-bedrock-ubuntu-18-04-mi\nnimal              articentgroupllc1635512619530:minecraft-bedrock-ubuntu-18-04-minimal:minecraft-bedrock-ubuntu-18-04-minimal:1.0.0     \n            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.0")]),s._v(".0\nx64             active-mq-on-ubuntu-eighteen                        apps-4-rent                         active-mq-on-ubuntu-eighteen     \n                   apps-4-rent:active-mq-on-ubuntu-eighteen:active-mq-on-ubuntu-eighteen:1.0.1                                           \n            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.0")]),s._v(".1\nx64             activemq_ubuntu18_04lts                             askforcloudllc1651766049149         activemq_ubuntu18_04lts          \n                   askforcloudllc1651766049149:activemq_ubuntu18_04lts:activemq_ubuntu18_04lts:0.0.1                                     \n            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".1\nx64             minecraft-bedrock-ubuntu-20-04-minimal              articentgroupllc1635512619530       minecraft-bedrock-ubuntu-20-04-mi\nnimal              articentgroupllc1635512619530:minecraft-bedrock-ubuntu-20-04-minimal:minecraft-bedrock-ubuntu-20-04-minimal:1.0.0     \n            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.0")]),s._v(".0\nx64             akaunting-on-ubuntu                                 apps-4-rent                         akaunting-on-ubuntu              \n                   apps-4-rent:akaunting-on-ubuntu:akaunting-on-ubuntu:1.0.1\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br")])]),a("blockquote",[a("p",[s._v("https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/linux_virtual_machine")]),s._v(" "),a("p",[s._v("https://www.terraform.io/language/functions/base64encode")]),s._v(" "),a("p",[s._v("https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/managed_disk")]),s._v(" "),a("p",[s._v("https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/virtual_machine_data_disk_attachment")]),s._v(" "),a("p",[s._v("查看可选用的系统镜像:")]),s._v(" "),a("p",[s._v("​\t https://learn.microsoft.com/en-us/azure/virtual-machines/linux/cli-ps-findimage")]),s._v(" "),a("p",[s._v("​\t https://learn.microsoft.com/en-us/azure/virtual-machines/linux/imaging")]),s._v(" "),a("p",[s._v("vm实例类型:")]),s._v(" "),a("p",[s._v("​\thttps://learn.microsoft.com/en-us/azure/virtual-machines/sizes")]),s._v(" "),a("p",[s._v("​\thttps://learn.microsoft.com/en-us/azure/virtual-machines/sizes-b-series-burstable")]),s._v(" "),a("p",[s._v("Azure 托管磁盘:")]),s._v(" "),a("p",[s._v("​\thttps://learn.microsoft.com/en-us/azure/virtual-machines/managed-disks-overview")]),s._v(" "),a("p",[s._v("​\thttps://learn.microsoft.com/en-us/azure/virtual-machines/disks-scalability-targets")]),s._v(" "),a("p",[s._v('这里依赖的是modules下面的模块创建的资源: "terraform-azure-operator/modules/vms"')])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入项目目录")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" terraform-azure-operator/env/dev/service\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建服务连接公私钥")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-pv")]),s._v(" config\n$ ssh-keygen "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" rsa "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" PEM "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" config/public_key  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建用于ssh连接的private key;(-f:指定文件名,-C:备注)")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" config/public_key config/public_key.pem\n\n$  tree  ./\n./\n├── backend.tf\n├── config\n│   ├── public_key.pem\n│   └── public_key.pub\n├── main.tf\n├── outputs.tf\n├── variables.tf\n├── versions.tf\n└── vms.tf\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" directory, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" files\n\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 依赖的公共参数")]),s._v("\n$  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" main.tf\ndata "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terraform_remote_state"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"network-data"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  backend "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"azurerm"')]),s._v("\n  config "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    resource_group_name  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terraform-demo"')]),s._v("\n    storage_account_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tfstateadmin111"')]),s._v("\n    container_name       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tfstate"')]),s._v("\n    key                  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"env/dev/network/terraform-network.tfstate"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nlocals "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  location_name       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"East US"')]),s._v("\n  resource_group_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terraform-demo"')]),s._v("\n  env_name            "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dev"')]),s._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里的`vms`和`vms_config`,会被`vms.tf`和`mount-data-disk.tf`使用到")]),s._v("\n  vms "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"server01"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"server02"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  vms_cofigs "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    server01 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      zone      "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1"')]),s._v("\n      subnet_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" data.terraform_remote_state.network-data.outputs.subnet_ids"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n      publicip  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" data.terraform_remote_state.network-data.outputs.public_ids"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n      nic_id    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" data.terraform_remote_state.network-data.outputs.nics_ids"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n    server02 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      zone      "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2"')]),s._v("\n      subnet_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" data.terraform_remote_state.network-data.outputs.subnet_ids"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n      publicip  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" data.terraform_remote_state.network-data.outputs.public_ids"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n      nic_id    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" data.terraform_remote_state.network-data.outputs.nics_ids"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建vms实例")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" vims.tf\nmodule "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"vms"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"../../../modules/vms"')]),s._v("\n  vms_size       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Standard_B2s"')]),s._v("\n  admin_username "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"adminuser"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里取消使用密码登录")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# admin_password                  = "root@123"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开启禁用密码登录参数")]),s._v("\n  disable_password_authentication "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n  os_disk_caching                 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ReadWrite"')]),s._v("\n  os_disk_storage_account_type    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Standard_LRS"')]),s._v("\n  os_disk_size                    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v("\n  source_image_publisher          "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Canonical"')]),s._v("\n  source_image_offer              "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"UbuntuServer"')]),s._v("\n  source_image_sku                "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"18.04-LTS"')]),s._v("\n  source_image_version            "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"latest"')]),s._v("\n  resource_group_name             "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" local.resource_group_name\n  location_name                   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" local.location_name\n  public_key_path                 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" file"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${path.module}")]),s._v('/config/public_key.pub"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  vms                             "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" local.vms\n  vms_cofigs                      "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" local.vms_cofigs\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建额外挂载的数据盘")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" mount-data-disk.tf\nmodule "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"attachment-data-disk"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("                         "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"../../../modules/data-disk"')]),s._v("\n  location_name                  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" local.location_name\n  resource_group_name            "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" local.resource_group_name\n  data_disk_option               "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Empty"')]),s._v("\n  data_disk_size                 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v("\n  data_disk_storage_account_type "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Standard_LRS"')]),s._v("\n  data_disk_in_os_id             "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10"')]),s._v("\n  data_disk_caching              "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ReadWrite"')]),s._v("\n  vms                            "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" local.vms\n  vms_cofigs                     "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" local.vms_cofigs\n  virtual_machine_ids            "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" module.vms.vms_ids\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 登录Azure")]),s._v("\n$ az login --use-device-code\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 声明环境变量")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TF_CLI_CONFIG_FILE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/home/terraform/youdianzhishi-terraform/terraform-azure-operator/.terraformrc\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行terraform命令")]),s._v("\n$ terraform init \n$ terraform "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("fmt")]),s._v(" 或 terraform init "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-recursive")]),s._v("\n$ terraform validate\n$ terraform plan\n$ terraform apply 或 terraform apply -auto-approve\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br"),a("span",{staticClass:"line-number"},[s._v("78")]),a("br"),a("span",{staticClass:"line-number"},[s._v("79")]),a("br"),a("span",{staticClass:"line-number"},[s._v("80")]),a("br"),a("span",{staticClass:"line-number"},[s._v("81")]),a("br"),a("span",{staticClass:"line-number"},[s._v("82")]),a("br"),a("span",{staticClass:"line-number"},[s._v("83")]),a("br"),a("span",{staticClass:"line-number"},[s._v("84")]),a("br"),a("span",{staticClass:"line-number"},[s._v("85")]),a("br"),a("span",{staticClass:"line-number"},[s._v("86")]),a("br"),a("span",{staticClass:"line-number"},[s._v("87")]),a("br"),a("span",{staticClass:"line-number"},[s._v("88")]),a("br"),a("span",{staticClass:"line-number"},[s._v("89")]),a("br"),a("span",{staticClass:"line-number"},[s._v("90")]),a("br"),a("span",{staticClass:"line-number"},[s._v("91")]),a("br"),a("span",{staticClass:"line-number"},[s._v("92")]),a("br"),a("span",{staticClass:"line-number"},[s._v("93")]),a("br"),a("span",{staticClass:"line-number"},[s._v("94")]),a("br"),a("span",{staticClass:"line-number"},[s._v("95")]),a("br"),a("span",{staticClass:"line-number"},[s._v("96")]),a("br"),a("span",{staticClass:"line-number"},[s._v("97")]),a("br"),a("span",{staticClass:"line-number"},[s._v("98")]),a("br"),a("span",{staticClass:"line-number"},[s._v("99")]),a("br"),a("span",{staticClass:"line-number"},[s._v("100")]),a("br"),a("span",{staticClass:"line-number"},[s._v("101")]),a("br"),a("span",{staticClass:"line-number"},[s._v("102")]),a("br"),a("span",{staticClass:"line-number"},[s._v("103")]),a("br"),a("span",{staticClass:"line-number"},[s._v("104")]),a("br"),a("span",{staticClass:"line-number"},[s._v("105")]),a("br"),a("span",{staticClass:"line-number"},[s._v("106")]),a("br"),a("span",{staticClass:"line-number"},[s._v("107")]),a("br"),a("span",{staticClass:"line-number"},[s._v("108")]),a("br"),a("span",{staticClass:"line-number"},[s._v("109")]),a("br"),a("span",{staticClass:"line-number"},[s._v("110")]),a("br"),a("span",{staticClass:"line-number"},[s._v("111")]),a("br"),a("span",{staticClass:"line-number"},[s._v("112")]),a("br")])]),a("p",[a("strong",[s._v("备注")]),s._v(":")]),s._v(" "),a("ul",[a("li",[s._v("项目这里创建linux虚拟机是调用modules下的vms模块进行创建的")]),s._v(" "),a("li",[s._v("控制台验证linux虚拟机的创建结果")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220923232502899.png",alt:"image-20220923232502899"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220923232402397.png",alt:"image-20220923232402397"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220923232436870.png",alt:"image-20220923232436870"}})]),s._v(" "),a("ul",[a("li",[s._v("远程登录服务测试")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用秘钥登录")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" public_key.pem adminuser@20.246.216.106\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用密码方式登录")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" adminuser@20.246.216.106\nThe authenticity of "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'20.246.216.106 (20.246.216.106)'")]),s._v(" can"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'t be established.\nECDSA key fingerprint is SHA256:+/iejTew26GoXSqEAPkZQtYa2YLYDd/OCTy1N55Eh3g.\nECDSA key fingerprint is MD5:ac:7b:4c:63:38:77:ff:56:71:bd:ec:fc:ef:e2:68:ff.\nAre you sure you want to continue connecting (yes/no)? yes\nWarning: Permanently added '")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20.246")]),s._v(".216.106"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("' (ECDSA) to the list of known hosts.\nadminuser@20.246.216.106'")]),s._v("s password: \nWelcome to Ubuntu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18.04")]),s._v(".6 LTS "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("GNU/Linux "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5.4")]),s._v(".0-1091-azure x86_64"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n * Documentation:  https://help.ubuntu.com\n * Management:     https://landscape.canonical.com\n * Support:        https://ubuntu.com/advantage\n\n  System information as of Fri Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":26:31 UTC "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("\n\n  System load:  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.09")]),s._v("              Processes:           "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("114")]),s._v("\n  Usage of /:   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4.9")]),s._v("% of "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(".89GB   Users logged in:     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n  Memory usage: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v("%               IP address "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" eth0: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".1.4\n  Swap usage:   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("%\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" updates can be applied immediately.\n\n\n\nThe programs included with the Ubuntu system are "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("free")]),s._v(" software"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nthe exact distribution terms "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" each program are described "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" the\nindividual files "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" /usr/share/doc/*/copyright.\n\nUbuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by\napplicable law.\n\nTo run a "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("command")]),s._v(" as administrator "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("user "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"root"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", use "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sudo <command>"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\nSee "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"man sudo_root"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" details.\n\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ef")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" nginx\nroot      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2250")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":22 ?        00:00:00 nginx: master process /usr/sbin/nginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-g")]),s._v(" daemon on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" master_process on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nwww-data  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2255")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2250")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":22 ?        00:00:00 nginx: worker process\nadminus+  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2478")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2440")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":27 pts/0    00:00:00 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--color")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("auto nginx\nadminuser@server01:~$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" http://localhost:80\nserver01\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br")])]),a("ul",[a("li",[s._v("访问linux虚拟机绑定的公网IP地址测试nginx服务是否正常")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220923232952072.png",alt:"image-20220923232952072"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220923233000791.png",alt:"image-20220923233000791"}})]),s._v(" "),a("h5",{attrs:{id:"注意"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注意"}},[s._v("#")]),s._v(" 注意:")]),s._v(" "),a("ul",[a("li",[s._v("Azure资源变更替换")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 先创建出来需要替换的资源,再来替换旧的资源")]),s._v("\n  lifecycle "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    create_before_destroy "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  \n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Azure 使用`create_before_destroy`后的错误(在Azure是直接进行modify修或者是遵循先destroy后create操作)")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Azure会对资源的名称进行一致性校验,所以创建同样名称的新资源是无法通过的")]),s._v("\n\n│ Error: A resource with the ID "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/subscriptions/d3a12c16-4024-403e-826f-fdd73da900e8/resourceGroups/terraform-demo/providers/Microsoft.Compute/virtualMachines/server02"')]),s._v(" already exists - to be managed via Terraform this resource needs to be imported into the State. Please see the resource documentation "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"azurerm_linux_virtual_machine"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("more")]),s._v(" information.\n│ \n│   with module.vms.azurerm_linux_virtual_machine.server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"server02"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n│   on "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("/modules/vms/main.tf line "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" resource "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"azurerm_linux_virtual_machine"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"server"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v("\n│    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(": resource "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"azurerm_linux_virtual_machine"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"server"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n│ \n╵\n╷\n│ Error: A resource with the ID "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/subscriptions/d3a12c16-4024-403e-826f-fdd73da900e8/resourceGroups/terraform-demo/providers/Microsoft.Compute/virtualMachines/server01"')]),s._v(" already exists - to be managed via Terraform this resource needs to be imported into the State. Please see the resource documentation "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"azurerm_linux_virtual_machine"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("more")]),s._v(" information.\n│ \n│   with module.vms.azurerm_linux_virtual_machine.server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"server01"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n│   on "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("/modules/vms/main.tf line "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" resource "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"azurerm_linux_virtual_machine"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"server"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v("\n│    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(": resource "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"azurerm_linux_virtual_machine"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"server"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n│ \n╵\nReleasing state lock. This may take a few moments"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("h4",{attrs:{id:"六、开通负载均衡器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#六、开通负载均衡器"}},[s._v("#")]),s._v(" 六、开通负载均衡器")]),s._v(" "),a("blockquote",[a("p",[s._v("https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/lb")]),s._v(" "),a("p",[s._v("https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/lb_backend_address_pool")]),s._v(" "),a("p",[s._v("https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/lb_backend_address_pool_address")]),s._v(" "),a("p",[s._v("https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/lb_rule")]),s._v(" "),a("p",[s._v('这里依赖的是modules下面的模块创建的资源: "terraform-azure-operator/modules/lb"')])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入项目目录")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" terraform-azure-operator/env/dev/service\n$  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" lb.tf\nmodule "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"lb"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("                 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"../../../modules/lb"')]),s._v("\n  lb_name                "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terraformdemo-lb"')]),s._v("\n  lb_sku                 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Standard"')]),s._v("\n  lb_backend_pool        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terraformdemo-lb-backend-pool"')]),s._v("\n  lb_rule_name           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terraformdemo-lb-rule"')]),s._v("\n  frontend_port          "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n  backend_port           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n  location_name          "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" local.location_name\n  resource_group_name    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" local.resource_group_name\n  public_ip_address_id   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" data.terraform_remote_state.network-data.outputs.lb_public_ip\n  vnet_id                "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" data.terraform_remote_state.network-data.outputs.virtual_network_id\n  vms_private_ip_address "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" module.vms.vms_private_ip_address\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 登录Azure")]),s._v("\n$ az login --use-device-code\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 声明环境变量")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TF_CLI_CONFIG_FILE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/home/terraform/youdianzhishi-terraform/terraform-azure-operator/.terraformrc\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行terraform命令")]),s._v("\n$ terraform init \n$ terraform "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("fmt")]),s._v(" 或 terraform init "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-recursive")]),s._v("\n$ terraform validate\n$ terraform plan\n$ terraform apply 或 terraform apply -auto-approve\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 自动迁移状态")]),s._v("\n$ terraform init -migrate-state\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 存储当前配置而不更改状态")]),s._v("\n$ terraform init "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-reconfigure")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br")])]),a("p",[a("strong",[s._v("备注")]),s._v(":")]),s._v(" "),a("ul",[a("li",[s._v("项目这里创建的负载均衡器是调用modules下的lb模块进行创建的")]),s._v(" "),a("li",[s._v("控制台验证负载均衡器的创建结果")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220924023359091.png",alt:"image-20220924023359091"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220924023431210.png",alt:"image-20220924023431210"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220924023555524.png",alt:"image-20220924023555524"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220924023457027.png",alt:"image-20220924023457027"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220924024606667.png",alt:"image-20220924024606667"}})]),s._v(" "),a("ul",[a("li",[s._v("测试负载均衡")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" http://20.169.228.129"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sort")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("uniq")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27")]),s._v(" server01\n     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("73")]),s._v(" server02\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h4",{attrs:{id:"七、dns解析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#七、dns解析"}},[s._v("#")]),s._v(" 七、dns解析")]),s._v(" "),a("ul",[a("li",[s._v("这里使用阿里云dns做一个模板,因为Azure用的是国外的资源;阿里云国内资源不能解析国外地址")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入项目目录")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" terraform-azure-operator/env/dev/service\n$  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" alicloud-dns.tf.origin\nlocals "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  dns_zone_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"chsaos.com"')]),s._v("\n  dns_record    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"azure"')]),s._v("\n  eip           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" data.terraform_remote_state.network-data.outputs.lb_public_address\n  record_type   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"CNAME"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# demo.chsaos.com")]),s._v("\nresource "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"alicloud_dns_record"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"record"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  name        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" local.dns_zone_name\n  host_record "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" local.dns_record\n  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" local.record_type\n  value       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" local.eip\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 需要使用api认证的export")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# export ALICLOUD_ACCESS_KEY="xxxxxx"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# export ALICLOUD_SECRET_KEY="xxxxxx"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# export ALICLOUD_REGION="cn-shanghai"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# export TF_CLI_CONFIG_FILE=/home/terraform/youdianzhishi-terraform/terraform-azure-operator/.terraformrc")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 登录Azure")]),s._v("\n$ az login --use-device-code\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 声明环境变量")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TF_CLI_CONFIG_FILE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/home/terraform/youdianzhishi-terraform/terraform-azure-operator/.terraformrc\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行terraform命令")]),s._v("\n$ terraform init \n$ terraform "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("fmt")]),s._v(" 或 terraform init "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-recursive")]),s._v("\n$ terraform validate\n$ terraform plan\n$ terraform apply 或 terraform apply -auto-approve\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br")])])])}),[],!1,null,null,null);a.default=e.exports}}]);