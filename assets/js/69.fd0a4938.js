(window.webpackJsonp=window.webpackJsonp||[]).push([[69],{403:function(e,v,a){"use strict";a.r(v);var _=a(4),s=Object(_.a)({},(function(){var e=this,v=e._self._c;return v("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[v("h4",{attrs:{id:"一、pod删除"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#一、pod删除"}},[e._v("#")]),e._v(" 一、"),v("code",[e._v("pod")]),e._v("删除")]),e._v(" "),v("ul",[v("li",[e._v("当删除"),v("code",[e._v("namespace")]),e._v("或"),v("code",[e._v("pod")]),e._v("等一些"),v("code",[e._v("Kubernetes")]),e._v("资源时,有时资源状态会卡在"),v("code",[e._v("terminating")]),e._v(",很长时间无法删除,甚至有时增加"),v("code",[e._v("--force flag")]),e._v("(强制删除)之后还是无法正常删除.这时就需要edit该资源,将字段"),v("code",[e._v("finalizers")]),e._v("设置为"),v("code",[e._v("null")]),e._v(",之后"),v("code",[e._v("Kubernetes")]),e._v("资源就正常删除了.")]),e._v(" "),v("li",[e._v("当删除"),v("code",[e._v("pod")]),e._v("时有时会卡住,"),v("code",[e._v("pod")]),e._v("状态变为"),v("code",[e._v("terminating")]),e._v(",无法删除"),v("code",[e._v("pod")])])]),e._v(" "),v("p",[v("strong",[e._v("强制删除")])]),e._v(" "),v("div",{staticClass:"language-shell line-numbers-mode"},[v("pre",{pre:!0,attrs:{class:"language-shell"}},[v("code",[e._v("kubectl delete pod pod_name "),v("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-n")]),e._v(" namespace_name "),v("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("--force")]),e._v(" --grace-period"),v("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),v("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("\n")])]),e._v(" "),v("div",{staticClass:"line-numbers-wrapper"},[v("span",{staticClass:"line-number"},[e._v("1")]),v("br")])]),v("p",[v("strong",[e._v("如果强制删除还不行,设置"),v("code",[e._v("finalizers")]),e._v("为空")])]),e._v(" "),v("ul",[v("li",[e._v("如果一个容器已经在运行,这时需要对一些容器属性进行修改,又不想删除容器,或不方便通过"),v("code",[e._v("replace")]),e._v("的方式进行更新."),v("code",[e._v("kubernetes")]),e._v("还提供了一种在容器运行时,直接对容器进行修改的方式,就是"),v("code",[e._v("patch")]),e._v("命令.")])]),e._v(" "),v("div",{staticClass:"language-shell line-numbers-mode"},[v("pre",{pre:!0,attrs:{class:"language-shell"}},[v("code",[e._v("kubectl patch pod pod_name "),v("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-n")]),e._v(" namespace_name "),v("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-p")]),e._v(" "),v("span",{pre:!0,attrs:{class:"token string"}},[e._v('\'{"metadata":{"finalizers":null}}\'')]),e._v("\n")])]),e._v(" "),v("div",{staticClass:"line-numbers-wrapper"},[v("span",{staticClass:"line-number"},[e._v("1")]),v("br")])]),v("h5",{attrs:{id:"从etcd中删除源数据"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#从etcd中删除源数据"}},[e._v("#")]),e._v(" 从"),v("code",[e._v("ETCD")]),e._v("中删除源数据")]),e._v(" "),v("ul",[v("li",[e._v("不推荐")])]),e._v(" "),v("div",{staticClass:"language-shell line-numbers-mode"},[v("pre",{pre:!0,attrs:{class:"language-shell"}},[v("code",[v("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 删除default namespace下的pod名为pod-to-be-deleted-0")]),e._v("\n    "),v("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("ETCDCTL_API")]),v("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),v("span",{pre:!0,attrs:{class:"token number"}},[e._v("3")]),e._v(" etcdctl del /registry/pods/default/pod-to-be-deleted-0\n    \n    "),v("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 删除需要删除的NAMESPACE")]),e._v("\n    etcdctl del /registry/namespaces/NAMESPACENAME"),v("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("/pre"),v("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("\n")])]),e._v(" "),v("div",{staticClass:"line-numbers-wrapper"},[v("span",{staticClass:"line-number"},[e._v("1")]),v("br"),v("span",{staticClass:"line-number"},[e._v("2")]),v("br"),v("span",{staticClass:"line-number"},[e._v("3")]),v("br"),v("span",{staticClass:"line-number"},[e._v("4")]),v("br"),v("span",{staticClass:"line-number"},[e._v("5")]),v("br")])]),v("h4",{attrs:{id:"二、删除pv-pvc"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#二、删除pv-pvc"}},[e._v("#")]),e._v(" 二、删除"),v("code",[e._v("pv/pvc")])]),e._v(" "),v("div",{staticClass:"language-shell line-numbers-mode"},[v("pre",{pre:!0,attrs:{class:"language-shell"}},[v("code",[v("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 强制删除")]),e._v("\nkubectl delete "),v("span",{pre:!0,attrs:{class:"token function"}},[e._v("pv")]),e._v(" pv_name "),v("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("--force")]),e._v(" --grace-period"),v("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),v("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("\nkubectl delete pvc pvc_name "),v("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-n")]),e._v(" namespace_name "),v("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("--force")]),e._v(" --grace-period"),v("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),v("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("\n\n"),v("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# finalizers")]),e._v("\nkubectl patch "),v("span",{pre:!0,attrs:{class:"token function"}},[e._v("pv")]),e._v(" pv-nfs-gysl "),v("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-p")]),e._v(" "),v("span",{pre:!0,attrs:{class:"token string"}},[e._v('\'{"metadata":{"finalizers":null}}\'')]),e._v("\nkubectl patch pvc minio-pvc "),v("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-p")]),e._v(" "),v("span",{pre:!0,attrs:{class:"token string"}},[e._v('\'{"metadata":{"finalizers": []}}\'')]),e._v(" "),v("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("--type")]),v("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("merge "),v("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-n")]),e._v(" minio\n\n")])]),e._v(" "),v("div",{staticClass:"line-numbers-wrapper"},[v("span",{staticClass:"line-number"},[e._v("1")]),v("br"),v("span",{staticClass:"line-number"},[e._v("2")]),v("br"),v("span",{staticClass:"line-number"},[e._v("3")]),v("br"),v("span",{staticClass:"line-number"},[e._v("4")]),v("br"),v("span",{staticClass:"line-number"},[e._v("5")]),v("br"),v("span",{staticClass:"line-number"},[e._v("6")]),v("br"),v("span",{staticClass:"line-number"},[e._v("7")]),v("br"),v("span",{staticClass:"line-number"},[e._v("8")]),v("br")])]),v("h4",{attrs:{id:"三、k8s删除流程"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#三、k8s删除流程"}},[e._v("#")]),e._v(" 三、"),v("code",[e._v("k8s")]),e._v("删除流程")]),e._v(" "),v("p",[e._v("基本的"),v("code",[e._v("delete")]),e._v("命令状态图")]),e._v(" "),v("p",[v("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20221219231726089.png",alt:"image-20221219231726089"}})]),e._v(" "),v("p",[e._v("尽管此操作很简单,但其他因素可能会干扰删除,包括"),v("code",[e._v("finalizers")]),e._v("和"),v("code",[e._v("owner references")]),e._v(".")]),e._v(" "),v("p",[v("strong",[v("code",[e._v("K8s")]),e._v("中对象删除基本流程如下:")])]),e._v(" "),v("ul",[v("li",[e._v("1.客户端提交删除请求到"),v("code",[e._v("API Server")]),e._v("(可选传递"),v("code",[e._v("GracePeriodSeconds")]),e._v("参数)")]),e._v(" "),v("li",[e._v("2."),v("code",[e._v("API Server")]),e._v("做"),v("code",[e._v("Graceful Deletion")]),e._v("检查(若对象实现了"),v("code",[e._v("RESTGracefulDeleteStrategy")]),e._v("接口,会调用对应的实现并返回是否需要进行"),v("code",[e._v("Graceful")]),e._v("删除)")]),e._v(" "),v("li",[e._v("3."),v("code",[e._v("API Server")]),e._v("检查"),v("code",[e._v("Finalizers")]),e._v("并结合是否需要进行"),v("code",[e._v("graceful")]),e._v("删除,来决定是否立即删除对象(若对象需要进行"),v("code",[e._v("graceful")]),e._v("删除,更新"),v("code",[e._v("metadata.DeletionGracePeriodSecond")]),e._v("和"),v("code",[e._v("metadata.DeletionTimestamp")]),e._v("字段,不从存储中删除对象;若对象不需要进行"),v("code",[e._v("Graceful")]),e._v("删除时: "),v("code",[e._v("metadata.Finalizers")]),e._v("为空,直接删除."),v("code",[e._v("metadata.Finalizers")]),e._v("不为空,不删除,只更新"),v("code",[e._v("metadata.DeletionTimestamp")]),e._v(".")])]),e._v(" "),v("h5",{attrs:{id:"finalizers介绍"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#finalizers介绍"}},[e._v("#")]),e._v(" "),v("code",[e._v("finalizers")]),e._v("介绍")]),e._v(" "),v("p",[v("code",[e._v("Finalizers")]),e._v("字段属于"),v("code",[e._v("Kubernetes GC")]),e._v("垃圾收集器,是一种删除拦截机制,能够让控制器实现异步的删除前("),v("code",[e._v("Pre-delete")]),e._v(")回调.其存在于任何一个资源对象的"),v("code",[e._v("Meta")]),e._v("中,在"),v("code",[e._v("k8s")]),e._v("源码中声明为"),v("code",[e._v("[]string")]),e._v(",该"),v("code",[e._v("Slice")]),e._v("的内容为需要执行的拦截器名称.")]),e._v(" "),v("p",[v("strong",[e._v("常见用途:")])]),e._v(" "),v("ul",[v("li",[e._v("1.控制器在对象刚创建时,在"),v("code",[e._v("metadata.finalizers")]),e._v("写入一个自定义字符串")]),e._v(" "),v("li",[e._v("2."),v("code",[e._v("APIServer")]),e._v("在"),v("code",[e._v("metadata.finalizers")]),e._v("数组不为空时,不会删除对象.此逻辑是硬性,对所有对象生效.")]),e._v(" "),v("li",[e._v("3.当有客户端删除对象时,控制器可以发现对象出于删除状态,然后执行相应的"),v("code",[e._v("pre-delete")]),e._v("逻辑.执行完成后,将之前写入的自定义字符串移除.")]),e._v(" "),v("li",[e._v("4.当所有控制器都将各自写入到"),v("code",[e._v("metadata.finalizers")]),e._v("的字符串移除后."),v("code",[e._v("API Server")]),e._v("就自动将对象删除.")])]),e._v(" "),v("p",[e._v("**注：**若对象同时实现了"),v("code",[e._v("graceful")]),e._v("删除策略,删除请求需要满足"),v("code",[e._v("GracefulPeriodSeconds = 0")]),e._v("条件")]),e._v(" "),v("h5",{attrs:{id:"graceful-deletion"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#graceful-deletion"}},[e._v("#")]),e._v(" "),v("code",[e._v("Graceful Deletion")])]),e._v(" "),v("p",[v("code",[e._v("APIServer")]),e._v("在处理"),v("code",[e._v("Pod")]),e._v("删除请求时,会根据"),v("code",[e._v("pod")]),e._v("的"),v("code",[e._v("pod.Spec.TerminationGracePeriodSeconds")]),e._v("和"),v("code",[e._v("deleteOptions.GracefulPeriodSeconds")]),e._v("综合判断,是否进行"),v("code",[e._v("Graceful")]),e._v("删除.若是,并判断最终的"),v("code",[e._v("GracefulPeriodSeconds")]),e._v("该设置为多少.")]),e._v(" "),v("ul",[v("li",[e._v("1.当删除请求选项中有设置"),v("code",[e._v("GracefulPeriodSeconds")]),e._v(",以选项中为准.若没有,使用"),v("code",[e._v("pod.Spec.TerminationGracePeriodSeconds")]),e._v(".若 "),v("code",[e._v("pod.Spec.TerminationGracePeriodSeconds")]),e._v("也没有设置,使用默认值"),v("code",[e._v("0")]),e._v(".")]),e._v(" "),v("li",[e._v("2.当"),v("code",[e._v("Pod")]),e._v("没有调度,或者已经结束(无论成功还是失败)."),v("code",[e._v("GracePeriodSeconds")]),e._v("都重置为"),v("code",[e._v("0")]),e._v(".")])]),e._v(" "),v("p",[v("code",[e._v("GracePeriodSeconds")]),e._v("为"),v("code",[e._v("0")]),e._v("表示不进行优雅删除.非"),v("code",[e._v("0")]),e._v("表示进行优雅删除."),v("code",[e._v("Pod")]),e._v("的默认优雅删除时间为"),v("code",[e._v("30s")]),e._v(",在对象创建时配置在"),v("code",[e._v("pod.Spec.TerminationGracePeriodSeconds")]),e._v("字段.")]),e._v(" "),v("p",[e._v("优雅删除的目的是给予"),v("code",[e._v("Kubelet")]),e._v("一定时间对"),v("code",[e._v("Pod")]),e._v("实行优雅退出.在用户对"),v("code",[e._v("Pod")]),e._v("执行"),v("code",[e._v("Delete")]),e._v("操作时,"),v("code",[e._v("Pod")]),e._v("对象不会立即从"),v("code",[e._v("API Server")]),e._v("删除,而只是进入"),v("code",[e._v("Termination")]),e._v("阶段."),v("code",[e._v("Kubelet")]),e._v("会对运行中的"),v("code",[e._v("Pod")]),e._v("的容器发送"),v("code",[e._v("TERM")]),e._v("信号,通知其退出.并执行用户配置的"),v("code",[e._v("preStop hooks")]),e._v("逻辑.当优雅时间过了之后,再开始使用"),v("code",[e._v("KILL")]),e._v("信号尝试强制杀容器.")]),e._v(" "),v("p",[e._v("当"),v("code",[e._v("kubelet")]),e._v("将"),v("code",[e._v("Pod")]),e._v("清理干净后,就会使用"),v("code",[e._v("GracefulPeriodSeconds==0")]),e._v("的参数执行删除操作.")]),e._v(" "),v("p",[e._v("因为"),v("code",[e._v("Pod")]),e._v("实现优雅删除目的是为了给予"),v("code",[e._v("Kubelet")]),e._v("时间做资源清理操作,所以这也是为什么在设置"),v("code",[e._v("GracePeriodSeconds")]),e._v("阶段,若"),v("code",[e._v("Pod")]),e._v("没有被调度或者已经退出,也就可以直接允许立即删除("),v("code",[e._v("GracePeriodSeconds = 0")]),e._v(").")]),e._v(" "),v("p",[v("strong",[e._v("注:")])]),e._v(" "),v("ul",[v("li",[e._v("理解该流程可以结合"),v("code",[e._v("Kubernetes")]),e._v("官网的"),v("code",[e._v("Pod Termination")]),e._v("说明：https://kubernetes.io/docs/concepts/workloads/pods/pod/#termination-of-pods")]),e._v(" "),v("li",[e._v("对象第一次执行优雅删除操作时,会将当时"),v("code",[e._v("GracefulPeriodSeconds")]),e._v("配置在"),v("code",[e._v("metadata.DeletionGracefulPeriodSeconds")]),e._v("字段.")]),e._v(" "),v("li",[v("code",[e._v("Deletion")]),e._v("操作在"),v("code",[e._v("API Server")]),e._v("是不可回退的操作."),v("code",[e._v("metadata.DeletionTimestamp")]),e._v("设置后不可更改,"),v("code",[e._v("metadata.DeletionGracefulPeriodSeconds")]),e._v("只能减小,不能增加.")])]),e._v(" "),v("h5",{attrs:{id:"对象无法删除的原因"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#对象无法删除的原因"}},[e._v("#")]),e._v(" 对象无法删除的原因")]),e._v(" "),v("p",[e._v("了解以上机制后,对象无法删除无外乎以下两个原因:")]),e._v(" "),v("ul",[v("li",[e._v("对象存在"),v("code",[e._v("finalizers")]),e._v(",关联的控制器故障未能执行或执行"),v("code",[e._v("finalizer")]),e._v("函数卡住\n"),v("ul",[v("li",[e._v("比如"),v("code",[e._v("namespace")]),e._v("控制器无法删除完空间内所有的对象,特别是在使用"),v("code",[e._v("aggregated apiserver")]),e._v("时,第三方"),v("code",[e._v("apiserver")]),e._v("服务故障导致无法删除其对象.此时,需要会恢复第三方"),v("code",[e._v("apiserver")]),e._v("服务或移除该"),v("code",[e._v("apiserver")]),e._v("的聚合,具体选择哪种方案需根据实际情况而定.")]),e._v(" "),v("li",[e._v("集群内安装的控制器给一些对象增加了自定义"),v("code",[e._v("finalizers")]),e._v(",未删除完"),v("code",[e._v("fianlizers")]),e._v("就下线了该控制器,导致这些"),v("code",[e._v("fianlizers")]),e._v("没有控制器来移除他们.此时,需要恢复该控制器会手动移除"),v("code",[e._v("finalizers")]),e._v(",具体选择哪种方案根据实际情况而定.")])])]),e._v(" "),v("li",[e._v("对象需要优雅删除,但执行者不能完成删除.比如"),v("code",[e._v("Pod")]),e._v("因为"),v("code",[e._v("kubelet")]),e._v("无法下线节点上"),v("code",[e._v("node")]),e._v("容器、存储卷而无法删除.比较常见有以下原因:\n"),v("ul",[v("li",[v("code",[e._v("kubelet")]),e._v("无法通过"),v("code",[e._v("container runtime")]),e._v("杀死进程.比如进程进入"),v("code",[e._v("D(Uninterruptible)")]),e._v("状态,"),v("code",[e._v("container runtime")]),e._v("或操作内核遇到"),v("code",[e._v("bug")]),e._v("等.对于进程进入"),v("code",[e._v("D")]),e._v("状态,若能恢复照成"),v("code",[e._v("D")]),e._v("的故障,比如恢复关联的外设访问等,能解决问题.若不能,或者是因为后者内核"),v("code",[e._v("bug")]),e._v(",一般并不能走正常流程让"),v("code",[e._v("kubelet")]),e._v("杀死进程.一般需要重启操作系统才能解决.")]),e._v(" "),v("li",[v("code",[e._v("kubelet")]),e._v("进程停止或者"),v("code",[e._v("node")]),e._v("失去联系. 该情况下,并没有"),v("code",[e._v("kubelet")]),e._v("运行或者运行中的"),v("code",[e._v("kubelet")]),e._v("与"),v("code",[e._v("apiserver")]),e._v("已经断开,无法收到 "),v("code",[e._v("pod")]),e._v("需要删除下线的消息.所以,没有执行者来进行优雅删除.该情况下,需要恢复节点以及"),v("code",[e._v("kubelet")]),e._v("的运行即可.")])])])]),e._v(" "),v("p",[v("strong",[e._v("两种机制都有强制跳过的方案:")])]),e._v(" "),v("ul",[v("li",[e._v("删除"),v("code",[e._v("finalizers")]),e._v(",让关联的逻辑不需要执行")]),e._v(" "),v("li",[v("code",[e._v("kubelet delete --force --grace-period 0")]),e._v("直接删除")])])])}),[],!1,null,null,null);v.default=s.exports}}]);