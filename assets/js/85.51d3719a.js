(window.webpackJsonp=window.webpackJsonp||[]).push([[85],{419:function(s,a,t){"use strict";t.r(a);var n=t(4),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h4",{attrs:{id:"一、terraform-backend简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、terraform-backend简介"}},[s._v("#")]),s._v(" 一、Terraform Backend简介")]),s._v(" "),a("h5",{attrs:{id:"state"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#state"}},[s._v("#")]),s._v(" state")]),s._v(" "),a("p",[a("code",[s._v("Terraform")]),s._v("可以根据state跟踪管理资源,默认文件存储在本地,(local),可以使用backend{}定义远程的存储(remote).")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("terraform.tfstate\nterraform.tfstate.backup\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"version"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(",\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terraform_version"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1.1.9"')]),s._v(",\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"serial"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(",\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"lineage"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5ef63fd0-168d-9d5d-4ce4-6a4f2dc0e5e8"')]),s._v(",\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"output"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resources"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"module"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"module.mydns"')]),s._v(",\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mode"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"managed"')]),s._v(",\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"type"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"alicloud_dns_record"')]),s._v(",\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"record"')]),s._v(",\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"provider"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"provider['),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("register.terraform.io/hashicorp/alicloud"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(']"')]),s._v(",\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"instances"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(","),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("p",[a("strong",[s._v("配置远程后端允许许多人在同一个基础设施上工作")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220915161147329.png",alt:"image-20220915161147329"}})]),s._v(" "),a("h5",{attrs:{id:"local-state存在的问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#local-state存在的问题"}},[s._v("#")]),s._v(" local state存在的问题")]),s._v(" "),a("p",[s._v("1.缺乏灵活性")]),s._v(" "),a("ul",[a("li",[s._v("状态文件存储在本地,不便于团队成员协同")]),s._v(" "),a("li",[s._v("文件系统损坏,导致状态文件丢失")])]),s._v(" "),a("p",[s._v("2.缺乏安全性")]),s._v(" "),a("ul",[a("li",[s._v("state存在敏感数据,缺乏数据的保护")]),s._v(" "),a("li",[s._v("当多人同时变更时,存在状态不一致导致基础设施风险")])]),s._v(" "),a("h5",{attrs:{id:"remote-backend"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#remote-backend"}},[s._v("#")]),s._v(" remote backend")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220915161731994.png",alt:"image-20220915161731994"}})]),s._v(" "),a("h5",{attrs:{id:"工作原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#工作原理"}},[s._v("#")]),s._v(" 工作原理")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220915161828884.png",alt:"image-20220915161828884"}})]),s._v(" "),a("h4",{attrs:{id:"二、backend配置阿里云oss"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、backend配置阿里云oss"}},[s._v("#")]),s._v(" 二、Backend配置阿里云OSS")]),s._v(" "),a("ul",[a("li",[s._v("OSS Backend这里是基于阿里云的表格存储服务(Tablestore)和对象存储服务(OSS)实现\n"),a("ul",[a("li",[s._v("表格存储的是"),a("code",[s._v("Lock")]),s._v("信息")]),s._v(" "),a("li",[s._v("对象储存主要是存放着状态文件(terraform.tfstate)")])])])]),s._v(" "),a("h5",{attrs:{id:"创建对象存储和表格服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建对象存储和表格服务"}},[s._v("#")]),s._v(" 创建对象存储和表格服务")]),s._v(" "),a("blockquote",[a("p",[s._v("https://registry.terraform.io/providers/aliyun/alicloud/latest/docs/resources/oss_bucket")]),s._v(" "),a("p",[s._v("https://registry.terraform.io/providers/aliyun/alicloud/latest/docs/resources/ots_instance")]),s._v(" "),a("p",[s._v("https://registry.terraform.io/providers/aliyun/alicloud/latest/docs/resources/ots_table")]),s._v(" "),a("p",[s._v('项目目录: "youdianzhishi-terraform/terraform-backend-demo"')])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## vim  main.tf")]),s._v("\nprovider "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"alicloud"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  access_key "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" var.alicloud_access_key\n  secret_key "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" var.alicloud_secret_key\n  region     "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cn-shanghai"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("alias")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"shanghai"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## OSS")]),s._v("\nresource "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"alicloud_oss_bucket"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terra-backend"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  bucket "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terraform-backend-data-202209"')]),s._v("\n  acl    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"private"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## tablestore")]),s._v("\nresource "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"alicloud_ots_instance"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terra-table"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  name        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terra-table"')]),s._v("\n  description "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terraform tablestore"')]),s._v("\n  accessed_by "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Any"')]),s._v("\n  tags "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    Created "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"TF"')]),s._v("\n    For     "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Building table"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nresource "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"alicloud_ots_table"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"basic"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  instance_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" alicloud_ots_instance.terra-table.name\n  table_name    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terra_table"')]),s._v("\n  primary_key "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"LockID"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"String"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  time_to_live                  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-1")]),s._v("\n  max_version                   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n  deviation_cell_version_in_sec "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## vim versions.tf")]),s._v("\nterraform "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  required_version "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1.2.8"')]),s._v(" // 这里是terraform的版本号,可以通过"),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("terraform "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("获取到\n  required_providers "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    alicloud "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"aliyun/alicloud"')]),s._v("\n      version "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1.183.0"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## vim variables.tf")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# variable "alicloud_access_key" {')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   type = string")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# }")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# variable "alicloud_secret_key" {')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   type = string")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# }")]),s._v("\n\nvariable "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"region"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" string\n  description "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"region name"')]),s._v("\n  default     "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cn-shanghai"')]),s._v("\n  sensitive   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## vim outputs.tf")]),s._v("\noutput "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"bucket_name"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  value "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" alicloud_oss_bucket.terra-backend.id\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\noutput "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"table_name"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  value "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" alicloud_ots_table.basic.id\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## terraform命令")]),s._v("\nterraform "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("fmt")]),s._v("\nterraform init\nterraform init -pulgin-dir"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=~")]),s._v("/.terraform.d/terraform-plugin-cache  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定terraform插件缓存目录 ")]),s._v("\nterraform validate\nterraform plan\nterraform apply -auto-approve\nterraform destroy -auto-approve\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br"),a("span",{staticClass:"line-number"},[s._v("78")]),a("br"),a("span",{staticClass:"line-number"},[s._v("79")]),a("br"),a("span",{staticClass:"line-number"},[s._v("80")]),a("br"),a("span",{staticClass:"line-number"},[s._v("81")]),a("br"),a("span",{staticClass:"line-number"},[s._v("82")]),a("br"),a("span",{staticClass:"line-number"},[s._v("83")]),a("br"),a("span",{staticClass:"line-number"},[s._v("84")]),a("br"),a("span",{staticClass:"line-number"},[s._v("85")]),a("br")])]),a("p",[s._v("**注意: ** 这里要给阿里云RAM开通OSS和Tablestore(OTS)权限")]),s._v(" "),a("h5",{attrs:{id:"工作原理-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#工作原理-2"}},[s._v("#")]),s._v(" 工作原理")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220915170200522.png",alt:"image-20220915170200522"}})]),s._v(" "),a("h5",{attrs:{id:"配置过程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置过程"}},[s._v("#")]),s._v(" 配置过程")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220915170400344.png",alt:"image-20220915170400344"}})]),s._v(" "),a("ul",[a("li",[a("p",[s._v("1.创建OSS对象存储bucket(存储state文件)")]),s._v(" "),a("blockquote",[a("p",[s._v('参考仓库目录"youdianzhishi-terraform/terraform-backend-demo"')])])]),s._v(" "),a("li",[a("p",[s._v("2.创建Tablestore表格存储(存储state的Lock信息)")]),s._v(" "),a("blockquote",[a("p",[s._v('参考仓库目录"youdianzhishi-terraform/terraform-backend-demo"')])])]),s._v(" "),a("li",[a("p",[s._v("3.创建backent.tf配置Terraform backend")]),s._v(" "),a("blockquote",[a("p",[s._v('参考仓库目录"youdianzhishi-terraform/terraform-module-example/env/dev"')])])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## vim backend.tf  ")]),s._v("\nterraform "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  backend "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"oss"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    access_key          "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"xxxxxx"')]),s._v("\n    secret_key          "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"xxxxxx"')]),s._v("\n    bucket              "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terraform-backend-data-202209"')]),s._v("\n    prefix              "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dev/"')]),s._v("\n    key                 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terraform-dev.tfstate"')]),s._v("\n    region              "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cn-shanghai"')]),s._v("\n    tablestore_endpoint "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://terra-table.cn-shanghai.ots.aliyuncs.com"')]),s._v("\n    tablestore_table    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terra_table"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## terraform命令")]),s._v("\nterraform "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("fmt")]),s._v("\nterraform "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("fmt")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-recursive")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 递归格式化")]),s._v("\nterraform validate\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 重新init")]),s._v("\n$ terraform  init \nInitializing modules"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\nInitializing the backend"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\nSuccessfully configured the backend "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"oss"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" Terraform will automatically\nuse this backend unless the backend configuration changes.\n\nInitializing provider plugins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n- Reusing previous version of aliyun/alicloud from the dependency lock "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v("\n- Reusing previous version of hashicorp/alicloud from the dependency lock "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v("\n- Using previously-installed aliyun/alicloud v1.183.0\n- Using previously-installed hashicorp/alicloud v1.185.0\n\n╷\n│ Warning: Additional provider information from registry\n│ \n│ The remote registry returned warnings "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" registry.terraform.io/hashicorp/alicloud:\n│ - For "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("users")]),s._v(" on Terraform "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.13")]),s._v(" or greater, this provider has moved to aliyun/alicloud. Please update your "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" required_providers.\n╵\n\nTerraform has been successfully initialized"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\n\nYou may now begin working with Terraform. Try running "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terraform plan"')]),s._v(" to see\nany changes that are required "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" your infrastructure. All Terraform commands\nshould now work.\n\nIf you ever "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" or change modules or backend configuration "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" Terraform,\nrerun this "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("command")]),s._v(" to reinitialize your working directory. If you forget, other\ncommands will detect it and remind you to "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" so "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" necessary.\n\n\nterraform apply -auto-approve\nterraform destroy -auto-approve\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br")])]),a("p",[s._v("**注意: ** 这里如果有状态的话,会有合并提示,此时本地的"),a("code",[s._v("terraform.tfstate")]),s._v("文件就可以删除了(.terraform目录中的"),a("code",[s._v("terraform.tfstate")]),s._v("不可以删除)")]),s._v(" "),a("h5",{attrs:{id:"模拟多人在线同时操作同一项目"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#模拟多人在线同时操作同一项目"}},[s._v("#")]),s._v(" 模拟多人在线同时操作同一项目")]),s._v(" "),a("ul",[a("li",[s._v("1.这里执行删除之前创建的资源")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ terraform destroy -auto-approve\nmodule.myecs.data.alicloud_images.images_ds: Reading"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nmodule.myvpc.alicloud_vpc.vpc: Refreshing state"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("vpc-uf6up62mmoxs0o2vr1glv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nalicloud_ots_instance.terra-table: Refreshing state"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("terra-table"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nalicloud_oss_bucket.terra-backend: Refreshing state"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("terraform-backend-data-202209"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nalicloud_ots_table.basic: Refreshing state"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("terra-table:terra_table"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nmodule.myvpc.alicloud_vswitch.vsw: Refreshing state"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("vsw-uf6rbrz51u79wwkkoj0tg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nmodule.mysecgroup.alicloud_security_group.group: Refreshing state"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sg-uf650pajfjei25kqra6d"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nmodule.mysecgroup.alicloud_security_group_rule.allow_22_tcp: Refreshing state"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sg-uf650pajfjei25kqra6d:ingress:tcp:22/22:intranet:0.0.0.0/0:accept:1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nmodule.mysecgroup.alicloud_security_group_rule.allow_80_tcp: Refreshing state"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sg-uf650pajfjei25kqra6d:ingress:tcp:80/80:intranet:0.0.0.0/0:accept:1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nmodule.mysecgroup.alicloud_security_group_rule.allow_all_tcp: Refreshing state"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sg-uf650pajfjei25kqra6d:egress:tcp:1/65535:intranet:0.0.0.0/0:accept:1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nmodule.myecs.data.alicloud_images.images_ds: Read complete after 4s "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("849117728")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nmodule.myecs.alicloud_instance.myecs: Refreshing state"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("i-uf684rg8x8mae96suyjn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nmodule.mydns.alicloud_dns_record.record: Refreshing state"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("785176334420716544")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\nTerraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:\n  - destroy\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("ul",[a("li",[s._v("2.打开另外一个项目执行资源创建")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ terraform apply \n╷\n│ Error: Error acquiring the state lock  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里提示占用了锁")]),s._v("\n│ \n│ Error message: OTSConditionCheckFail Condition check failed. 0005e8b4-6132-aa86-42d7-2b0a00a5f6ca\n│ Lock Info:\n│   ID:        1ab59afd-9fa1-7a16-67e5-3b04538804c8\n│   Path:      terraform-backend-data-202209/dev/terraform-dev.tfstate\n│   Operation: OperationTypeApply\n│   Who:       root@centos-base\n│   Version:   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.2")]),s._v(".8\n│   Created:   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-09-15 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":04:58.962045604 +0000 UTC\n│   Info:      \n│ \n│ \n│ Terraform acquires a state lock to protect the state from being written\n│ by multiple "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("users")]),s._v(" at the same time. Please resolve the issue above and try\n│ again. For "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("most")]),s._v(" commands, you can disable locking with the "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-lock=false"')]),s._v("\n│ flag, but this is not recommended.\n╵\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("h4",{attrs:{id:"三、backend扩展"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、backend扩展"}},[s._v("#")]),s._v(" 三、Backend扩展")]),s._v(" "),a("h5",{attrs:{id:"命令行配置backend"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#命令行配置backend"}},[s._v("#")]),s._v(" 命令行配置backend")]),s._v(" "),a("ul",[a("li",[s._v("指定配置文件")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ terraform init -backend-config"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/path/to/terraform/backend/file\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[s._v("指定配置参数")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("terraform init -backend-config"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"bucket=terraform-data"')]),s._v(" -backend-config"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"prefix=path/mystate"')]),s._v(" -backend-config"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"scheme=https"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h5",{attrs:{id:"terraform-remote-state"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#terraform-remote-state"}},[s._v("#")]),s._v(" terraform_remote_state")]),s._v(" "),a("ul",[a("li",[s._v("获取remote中state的数据(根模块的output)")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("output "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"myecs-public-ip"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tvalue "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" module.myecs.ecs_ip\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\ndata "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terraform_reomte_state"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ecs_ip"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tbackend "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"oss"')]),s._v("\n\tconfig "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\taccess_key "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"xxxxxx"')]),s._v("\n\t\tsecret_key "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"xxxxxx"')]),s._v("\n\t\tbucket "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terraform-data"')]),s._v("\n\t\tprefix "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"path/mystate"')]),s._v("\n\t\tkey "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"terraform.tfstate"')]),s._v("\n\t\tregion "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cn-shanghai"')]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\noutput "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"remote_backend"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tvalue "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" data.terraform_remote_state.ecs_ip.output.myecs-public-ip\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("h5",{attrs:{id:"backend实践"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#backend实践"}},[s._v("#")]),s._v(" backend实践")]),s._v(" "),a("ul",[a("li",[s._v("配置多个backend-config,区分多个文件夹进行管理;")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 不同环境目录配置不同的backend.tf")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" youdianzhishi-terraform/terraform-backend-demo/envirments\ntree ./\n./\n├── dev\n│   ├── backend.tf\n│   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n├── prod\n│   ├── backend.tf\n│   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n├── stag\n│   ├── backend.tf\n│   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n└── "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\t└── backend.tf\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://bruce-log-img.oss-cn-shanghai.aliyuncs.com/image-20220915184626426.png",alt:"image-20220915184626426"}})])])}),[],!1,null,null,null);a.default=e.exports}}]);